#
# "Software pw3270, desenvolvido com base nos códigos fontes do WC3270  e X3270
# (Paul Mattes Paul.Mattes@usa.net), de emulação de terminal 3270 para acesso a
# aplicativos mainframe. Registro no INPI sob o nome G3270.
#
# Copyright (C) <2008> <Banco do Brasil S.A.>
#
# Este programa é software livre. Você pode redistribuí-lo e/ou modificá-lo sob
# os termos da GPL v.2 - Licença Pública Geral  GNU,  conforme  publicado  pela
# Free Software Foundation.
#
# Este programa é distribuído na expectativa de  ser  útil,  mas  SEM  QUALQUER
# GARANTIA; sem mesmo a garantia implícita de COMERCIALIZAÇÃO ou  de  ADEQUAÇÃO
# A QUALQUER PROPÓSITO EM PARTICULAR. Consulte a Licença Pública Geral GNU para
# obter mais detalhes.
#
# Você deve ter recebido uma cópia da Licença Pública Geral GNU junto com este
# programa;  se  não, escreva para a Free Software Foundation, Inc., 59 Temple
# Place, Suite 330, Boston, MA, 02111-1307, USA
#
# Contatos:
#
# perry.werneck@gmail.com	(Alexandre Perry de Souza Werneck)
# erico.mendonca@gmail.com	(Erico Mascarenhas de Mendonça)
# licinio@bb.com.br			(Licínio Luis Branco)
# kraucer@bb.com.br			(Kraucer Fernandes Mazuco)
#

PACKAGE_NAME=@PACKAGE_NAME@

#---[ Paths ]------------------------------------------------------------------

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
libdir=@libdir@
datarootdir=@datarootdir@
localedir=@localedir@
desktopdir=$(datarootdir)/applications

EXEEXT=@EXEEXT@
STRIP=@STRIP@
INSTALL=@INSTALL@
INSTALL_PROGRAM=$(INSTALL) -m 755
INSTALL_DATA=$(INSTALL) -m 644
CONVERT=@CONVERT@
WINDRES=@WINDRES@
LN_S=@LN_S@

DLL_FLAGS=@DLL_FLAGS@
LDFLAGS=@LDFLAGS@

#---[ Sources ]----------------------------------------------------------------

include common/sources.mak
include v3270/sources.mak
include uiparser/sources.mak

#---[ Targets ]----------------------------------------------------------------

APP_SOURCES=	main.c @APP_GUI_SRC@

LIB_SOURCES=	window.c actions.c fonts.c dialog.c hostdialog.c print.c colors.c \
				tools.c plugin.c trace.c \
				$(foreach SRC, $(UI_PARSER_SRC), uiparser/$(SRC)) \
				$(foreach SRC, $(V3270_SRC), v3270/$(SRC)) \
				$(foreach SRC, $(COMMON_SRC), common/$(SRC)) \
				filetransfer.c ft/ftdialog.c ft/ftprogress.c

DEPENDS=*.h common/*.h uiparser/*.h v3270/*.h $(GLOBAL_DEPS)

VALGRIND=@VALGRIND@

CFLAGS=@CFLAGS@ @DLL_CFLAGS@ @GTK_CFLAGS@ @GTKMAC_CFLAGS@ -DLIBDIR=\"$(libdir)\" -DDATAROOTDIR=\"$(datarootdir)\" -I../../src/include
LIBS=@LIBS@ @GTK_LIBS@ @GTKMAC_LIBS@ @SOCKET_LIBS@

#---[ Rules ]------------------------------------------------------------------

include ../include/rules.mak

%.png: pixmaps/%.svg
ifneq ($(CONVERT),no)
	@echo "  GEN  `basename $@`"
	@$(MKDIR) `dirname $@`
	@$(CONVERT) $< --format=png > $@
endif

%@OBJEXT@: %.rc
	@echo "  RC   `basename $@`"
	@mkdir -p `dirname $@`
	@$(WINDRES) --include-dir=. -i $< -o $@

$(OBJDBG)/%@OBJEXT@: %.rc
	@echo "  RC   `basename $@`"
	@mkdir -p `dirname $@`
	@$(WINDRES) --include-dir=. -i $< -o $@

$(OBJRLS)/%@OBJEXT@: %.rc
	@echo "  RC   `basename $@`"
	@mkdir -p `dirname $@`
	@$(WINDRES) --include-dir=. -i $< -o $@

#---[ Release targets ]--------------------------------------------------------

Release: $(BINDIR)/Release/$(PACKAGE_TARNAME)$(EXEEXT)

install: Release $(PACKAGE_NAME).desktop $(PACKAGE_NAME)-logo.png
	$(MKDIR) $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) $(BINDIR)/Release/$(PACKAGE_TARNAME)$(EXEEXT) $(DESTDIR)$(bindir)

	$(MKDIR) $(DESTDIR)$(libdir)
	$(INSTALL_PROGRAM) $(LIBRLS)/@DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@.@VERSION@ $(DESTDIR)$(libdir)
	$(LN_S) @DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@.@VERSION@ $(DESTDIR)$(libdir)/@DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@.@MAJOR_VERSION@
	$(LN_S) @DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@.@MAJOR_VERSION@ $(DESTDIR)$(libdir)/@DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@

	@$(MKDIR) $(DESTDIR)$(datarootdir)/$(PACKAGE_NAME)
	@$(INSTALL_DATA) $(PACKAGE_NAME).png $(DESTDIR)$(datarootdir)/$(PACKAGE_NAME)
	@$(INSTALL_DATA) $(PACKAGE_NAME)-logo.png $(DESTDIR)$(datarootdir)/$(PACKAGE_NAME)
	@$(MKDIR) $(DESTDIR)$(desktopdir)
	@desktop-file-install	--mode 644 \
				--dir $(DESTDIR)/$(desktopdir) \
				--add-category System \
				--add-category TerminalEmulator \
				$(PACKAGE_NAME).desktop

$(BINRLS)/$(PACKAGE_TARNAME)$(EXEEXT):	$(LIBRLS)/@DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@ \
					$(foreach SRC, $(basename $(APP_SOURCES)), $(OBJRLS)/$(SRC)$(OBJEXT))
	@echo "  CCLD `basename $@`"
	@$(MKDIR) `dirname $@`
	@$(LD) @LDARCH@ @LDAPPFLAGS@ -o $@ $(foreach SRC, $(basename $(APP_SOURCES)), $(OBJRLS)/$(SRC)$(OBJEXT)) $(LIBS) $(LIB3270_LIBS) -l$(PACKAGE_TARNAME)
	@$(STRIP) $@

$(LIBRLS)/@DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@: $(LIBRLS)/@DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@.@VERSION@
	@rm -f $@
	@cd $(LIBRLS) && $(LN_S) @DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@.@VERSION@ @DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@

$(LIBRLS)/@DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@.@VERSION@:	$(foreach SRC, $(basename $(LIB_SOURCES)), $(OBJRLS)/$(SRC)$(OBJEXT))
	@echo "  CCLD `basename $@`"
	@$(MKDIR) `dirname $@`
	@$(LD) $(DLL_FLAGS) $(LDFLAGS) @LDSOFLAGS@ @LDLIBFLAGS@ @RLS_LDFLAGS@ -o $@ $^ $(LIBS) $(LIB3270_LIBS)
	@$(STRIP) $@

#---[ Debug targets ]----------------------------------------------------------

Debug: $(BINDBG)/$(PACKAGE_TARNAME)$(EXEEXT)

$(BINDBG)/$(PACKAGE_TARNAME)$(EXEEXT):	$(LIBDBG)/@DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@ \
					$(foreach SRC, $(basename $(APP_SOURCES)), $(OBJDBG)/$(SRC)$(OBJEXT))
	@echo "  CCLD `basename $@`"
	@$(MKDIR) `dirname $@`
	$(LD) @LDARCH@ @DBGRPATH@ -o $@ $(foreach SRC, $(basename $(APP_SOURCES)), $(OBJDBG)/$(SRC)$(OBJEXT)) $(LIBS) $(LIB3270_LIBS) -l$(PACKAGE_TARNAME)

$(LIBDBG)/@DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@: $(LIBDBG)/@DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@.@VERSION@
	@rm -f $@
	@cd $(LIBDBG) && $(LN_S) @DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@.@VERSION@ @DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@

$(LIBDBG)/@DLLPREFIX@$(PACKAGE_TARNAME)@DLLEXT@.@VERSION@:	$(foreach SRC, $(basename $(LIB_SOURCES)), $(OBJDBG)/$(SRC)$(OBJEXT))
	@echo "  CCLD `basename $@`"
	@$(MKDIR) `dirname $@`
	@$(LD) $(DLL_FLAGS) $(LDFLAGS) @LDSOFLAGS@ @DBGRPATH@ -o $@ $^ $(LIBS) $(LIB3270_LIBS)

run: $(BINDIR)/Debug/$(PACKAGE_TARNAME)$(EXEEXT)
	@cd "$(ROOTDIR)" ; .bin/Debug/$(PACKAGE_TARNAME)$(EXEEXT)

memchk: $(BINDIR)/Debug/$(PACKAGE_TARNAME)$(EXEEXT)
ifeq ($(VALGRIND),no)
	@cd "$(ROOTDIR)" ; .bin/Debug/$(PACKAGE_TARNAME)$(EXEEXT)
else
	@cd "$(ROOTDIR)" ; G_DEBUG=gc-friendly G_SLICE=always-malloc \$(VALGRIND) --leak-check=full --suppressions=valgrind.suppression --gen-suppressions=all .bin/Debug/$(PACKAGE_TARNAME)$(EXEEXT)
#	@cd "$(ROOTDIR)" ; G_DEBUG=gc-friendly G_SLICE=always-malloc \$(VALGRIND) --leak-check=full --suppressions=valgrind.suppression .bin/Debug/$(PACKAGE_TARNAME)$(EXEEXT)
endif

#---[ Misc targets ]-----------------------------------------------------------

$(PACKAGE_NAME).desktop: Makefile $(PACKAGE_NAME).png
	@rm -f $@
	@echo "[Desktop Entry]" > $@
	@echo "Encoding=UTF-8" >> $@
	@echo "GenericName=$(PACKAGE_NAME)" >> $@
	@echo "Name=3270 Terminal" >> $@
	@echo "Name[pt_BR]=Terminal 3270" >> $@
	@echo "Comment=IBM 3270 Terminal emulator" >> $@
	@echo "Exec=$(bindir)/$(PACKAGE_NAME)@EXEEXT@" >> $@
	@echo "Icon=$(datarootdir)/$(PACKAGE_NAME)/$(PACKAGE_NAME).png" >> $@
	@echo "Terminal=false" >> $@
	@echo "Type=Application" >> $@
	@echo "StartupNotify=true" >> $@

v3270/marshal.h: v3270/genmarshal
	@$(MKDIR) `dirname $@`
	@glib-genmarshal --prefix=v3270 --header v3270/genmarshal > $@

v3270/marshal.c: v3270/genmarshal v3270/marshal.h
	@$(MKDIR) `dirname $@`
	@glib-genmarshal --prefix=v3270 --body v3270/genmarshal > $@

$(BINDIR)/pot/pw3270.pot: $(foreach SRC, $(basename $(APP_SOURCES) $(LIB_SOURCES)), $(TMPDIR)/pot/$(SRC).pot)
	@rm -f $@
	@mkdir -p `dirname $@`
	@$(MSGCAT) --sort-output $^ > $@

distclean: clean
	@rm -f $(PACKAGE_NAME).png
	@rm -f $(PACKAGE_NAME)-logo.png

clean: clean-common
	@rm -f v3270/marshal.c
	@rm -f v3270/marshal.h
	@rm -fr uiparser/.bin
	@rm -fr uiparser/.obj
	@rm -fr v3270/.bin
	@rm -fr v3270/.obj
	@rm -fr debian
	@rm -f $(PACKAGE_NAME).desktop

